// src/components/NotificationsBox.jsx
import React, { useEffect, useState } from 'react';
import { Card, ListGroup, Badge, Spinner, Button } from 'react-bootstrap';

/**
 * Simple NotificationsBox
 * - Fetches /api/notifications?recipient_user_id=#
 * - Attempts to find user id from localStorage (common keys) or from JWT
 * - Shows small list + unread count
 */

function parseJwtGetUserId(token) {
  if (!token) return null;
  try {
    const p = token.split('.')[1];
    if (!p) return null;
    const decoded = JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/')));
    // common claim keys: sub, user_id, id, uid
    return decoded.user_id || decoded.id || decoded.sub || null;
  } catch (e) {
    return null;
  }
}

function getToken() {
  try {
    const keys = ['token', 'accessToken', 'access_token', 'authToken', 'jwt'];
    for (const k of keys) {
      const v = localStorage.getItem(k);
      if (v) return v;
    }
    const auth = localStorage.getItem('auth');
    if (auth) {
      try {
        const parsed = JSON.parse(auth);
        if (parsed?.token) return parsed.token;
        if (parsed?.accessToken) return parsed.accessToken;
      } catch {}
    }
    const cookieMatch = document.cookie.match(/(?:^|; )(?:token|access_token|jwt)=([^;]+)/);
    if (cookieMatch) return decodeURIComponent(cookieMatch[1]);
    return null;
  } catch (e) {
    return null;
  }
}

export default function NotificationsBox() {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const load = async () => {
    setLoading(true);
    setError(null);
    try {
      const token = getToken();
      // try to get a user id from localStorage first (common key 'user' or 'me')
      let userId = null;
      try {
        const localUser = JSON.parse(localStorage.getItem('user') || localStorage.getItem('me') || '{}');
        if (localUser && (localUser.user_id || localUser.id)) userId = localUser.user_id || localUser.id;
      } catch (e) {
        // ignore
      }
      if (!userId) {
        // try decode token payload
        const t = token && token.startsWith('Bearer ') ? token.split(' ')[1] : token;
        userId = parseJwtGetUserId(t);
      }

      // If still no userId, don't include recipient query (backend will likely return [] or 401)
      const qs = userId ? `?recipient_user_id=${encodeURIComponent(userId)}` : '';
      const res = await fetch(`/api/notifications${qs}`, {
        headers: {
          Accept: 'application/json',
          ...(token ? { Authorization: token.startsWith('Bearer ') ? token : `Bearer ${token}` } : {}),
        },
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => null);
        throw new Error(txt || `Status ${res.status}`);
      }
      const rows = await res.json();
      setNotifications(rows || []);
    } catch (err) {
      console.error('Notifications load error', err);
      setError(err.message || 'Failed to load notifications');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    load();
    // optional: poll every 60s
    const id = setInterval(load, 60000);
    return () => clearInterval(id);
  }, []);

  const unreadCount = notifications.filter(n => !n.is_read && (n.is_read === 0 || n.is_read === false)).length;

  return (
    <Card className="mb-4 shadow">
      <Card.Header className="d-flex justify-content-between align-items-center">
        <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
          <strong>Notifications</strong>
          <Badge bg={unreadCount ? 'danger' : 'secondary'}>{unreadCount}</Badge>
        </div>
        <div>
          <Button variant="link" size="sm" onClick={load} style={{ textDecoration: 'none' }}>
            Refresh
          </Button>
        </div>
      </Card.Header>

      <Card.Body style={{ maxHeight: 300, overflowY: 'auto', padding: 0 }}>
        {loading ? (
          <div className="p-3 text-center"><Spinner animation="border" size="sm" /></div>
        ) : error ? (
          <div className="p-3 text-danger small">{error}</div>
        ) : (!notifications || notifications.length === 0) ? (
          <div className="p-3 text-muted small">No notifications</div>
        ) : (
          <ListGroup variant="flush">
            {notifications.map((n) => (
              <ListGroup.Item key={n.notification_id ?? n.id ?? Math.random()} className="d-flex justify-content-between align-items-start">
                <div>
                  <div style={{ fontWeight: 600 }}>{n.title || n.type}</div>
                  <div className="small text-muted">{n.body}</div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div className="small text-muted">{new Date(n.created_at || n.createdAt || Date.now()).toLocaleString()}</div>
                  {!n.is_read && <Badge bg="warning" className="mt-1">New</Badge>}
                </div>
              </ListGroup.Item>
            ))}
          </ListGroup>
        )}
      </Card.Body>
    </Card>
  );
}
